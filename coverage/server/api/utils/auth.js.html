<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for server/api/utils/auth.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">All files</a> / <a href="index.html">server/api/utils</a> auth.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.67% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>26/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">77.27% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>17/22</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>4/4</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.67% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>26/30</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-yes">25x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Configuration of the [express-jwt-policies](https://www.npmjs.com/package/express-jwt-policies) library.
 *
 * The settings in this file influence the behavior of the `auth.authenticate`
 * and `auth.authorize` functions used throughout `*.routes.js` files (in
 * `server/api/{subject}` directories) for authentication and/or authorization.
 *
 * @module server/api/utils/auth
 */
const expressJwtPolicies = require('express-jwt-policies');
&nbsp;
const config = require('../../../config');
const User = require('../../models/user');
const errors = require('./errors');
&nbsp;
const logger = config.logger('auth');
&nbsp;
module.exports = expressJwtPolicies({
&nbsp;
  /**
   * This middleware function is called by **express-jwt-policies** after
   * successful validation of a JWT token.
   *
   * It loads the user account corresponding to the "sub" claim of the token,
   * and attaches it to `req.currentUser` for later use by other middleware
   * functions.
   *
   * If no matching user is found or the user is inactive, a standard
   * unauthorized error (see {@link module:server/api/utils/errors}) is
   * forwarded to the next error middleware.  If another unexpected error
   * occurs, it is also forwarded to the next error-handling middleware.
   *
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authenticatedResourceLoader: function(req, res, next) {
    return User.where({
      api_id: req.jwtToken.sub || <span class="branch-1 cbranch-no" title="branch not covered" >''</span>
    }).fetch().then(user =&gt; {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (!user || !user.isActive()) {
<span class="cstat-no" title="statement not covered" >        throw errors.invalidAuthorization();</span>
      }
&nbsp;
      req.currentUser = user;
      logger.debug(`Authenticated as user ${user.get('api_id')}`);
    }).then(next).catch(next);
  },
&nbsp;
  /**
   * This error-handling middleware function is called by
   * **express-jwt-policies** if an authentication error occurs (i.e. a problem
   * with the JWT token or the authenticated resource loader above).
   *
   * If the error is a known error such as a missing or malformed JWT token, it
   * is replaced by a standard unauthorized error (see {@link
   * module:server/api/utils/errors}) and forwarded to the next error-handling
   * middleware. Unexpected errors are forwarded without change.
   *
   * @param {Error} err - The error that occurred.
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authenticationErrorHandler: function(err, req, res, next) {
    if (err.code == 'credentials_required') {
      logger.debug(`JWT authentication missing error: ${err.message}`);
      next(errors.missingAuthorization());
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (err.code == 'credentials_bad_format' || err.code == 'credentials_bad_scheme') {
<span class="cstat-no" title="statement not covered" >      logger.debug(`JWT authentication credentials error: ${err.message}`);</span>
<span class="cstat-no" title="statement not covered" >      next(errors.malformedAuthorization());</span>
    } else <span class="missing-if-branch" title="else path not taken" >E</span>if (err.status == 401) {
      logger.debug(`JWT authentication invalid error: ${err.message}`);
      next(errors.invalidAuthorization());
    } else {
<span class="cstat-no" title="statement not covered" >      next(err);</span>
    }
  },
&nbsp;
  /**
   * This error-handling middleware function is called by
   * **express-jwt-policies** if an authorization error occurs (i.e. a custom
   * policy function determined that a user does not have access to a specific
   * resource).
   *
   * Such an error is usually replaced by a standard forbidden error (see {@link
   * module:server/api/utils/errors}) and forwarded to the next error-handling
   * middleware.
   *
   * However, if the authorization options passed to `auth.authorize` include a
   * `resourceName` property and a resource ID is found in `req.params.id`, then
   * the error will instead be replaced by a standard record not found (404)
   * error.
   *
   * This is meant to prevent unauthorized user from being able to tell the
   * difference between a resource that does not exist and a resource which they
   * are not authorized to access. If the former produced a 404 Not Found
   * response and the latter a 403 Forbidden response, it would be a dead
   * giveaway that the latter resource exists while the former does not.
   * Responding with 404 Not Found in both cases conceals that information.
   *
   * If the resource has an identifier which is not `req.params.id`, a custom
   * `resourceId` function can be passed to `auth.authorize` to retrieve the
   * correct ID from the request:
   *
   *     auth.authorize(policyFunc, {
   *       resourceName: 'user',
   *       resourceId: (req) =&gt; req.params.customId
   *     });
   *
   * @param {Error} err - The error that occurred.
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authorizationErrorHandler: function(err, req, res, next) {
    if (err.status != 403) {
      return next(err);
    }
&nbsp;
    const resourceName = req.authOptions.resourceName;
    const resourceId = req.authOptions.resourceId ? <span class="branch-0 cbranch-no" title="branch not covered" >req.authOptions.resourceId(req) </span>: req.params.id;
    if (resourceName &amp;&amp; resourceId) {
      next(errors.recordNotFound(resourceName, resourceId));
      logger.debug(`Not authorized to access resource ${req.path} (${resourceName}/${resourceId})`);
    } else {
      next(errors.forbidden());
      logger.debug(`Not authorized to access resource ${req.path}`);
    }
  },
&nbsp;
  // JWT secret used by the **express-jwt-policies** library to verify token
  // signatures, taken from the server's configuration.
  jwtSecret: config.sessionSecret
});
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Tue Dec 19 2017 10:25:04 GMT+0100 (CET)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
