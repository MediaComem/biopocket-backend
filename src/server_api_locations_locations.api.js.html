<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/api/locations/locations.api.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Abstract.html">Abstract</a><ul class='methods'><li data-type='method'><a href="Abstract.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="Abstract.html#serializeTo">serializeTo</a></li></ul></li><li><a href="Database.html">Database</a><ul class='methods'><li data-type='method'><a href="Database.html#close">close</a></li><li data-type='method'><a href="Database.html#open">open</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="Location.html#serializeTo">serializeTo</a></li></ul></li><li><a href="module-scripts.AnonymizeScript.html">AnonymizeScript</a></li><li><a href="module-scripts.CreateAdminScript.html">CreateAdminScript</a></li><li><a href="module-scripts.SampleDataScript.html">SampleDataScript</a></li><li><a href="module-scripts-Script.html">Script</a><ul class='methods'><li data-type='method'><a href="module-scripts-Script.html#autoRun">autoRun</a></li><li data-type='method'><a href="module-scripts-Script.html#exit">exit</a></li><li data-type='method'><a href="module-scripts-Script.html#onFailure">onFailure</a></li><li data-type='method'><a href="module-scripts-Script.html#onSuccess">onSuccess</a></li><li data-type='method'><a href="module-scripts-Script.html#run">run</a></li></ul></li><li><a href="module-server_api_utils_errors-ApiError.html">ApiError</a></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#generateJwt">generateJwt</a></li><li data-type='method'><a href="User.html#hasPassword">hasPassword</a></li><li data-type='method'><a href="User.html#hasRole">hasRole</a></li><li data-type='method'><a href="User.html#isActive">isActive</a></li><li data-type='method'><a href="User.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="User.html#serializeTo">serializeTo</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-scripts.html">scripts</a></li><li><a href="module-server_api_auth.html">server/api/auth</a><ul class='methods'><li data-type='method'><a href="module-server_api_auth.html#.authenticate">authenticate</a></li><li data-type='method'><a href="module-server_api_auth.html#.canAuthenticate">canAuthenticate</a></li></ul></li><li><a href="module-server_api_locations.html">server/api/locations</a><ul class='methods'><li data-type='method'><a href="module-server_api_locations.html#.canCreate">canCreate</a></li><li data-type='method'><a href="module-server_api_locations.html#.canDestroy">canDestroy</a></li><li data-type='method'><a href="module-server_api_locations.html#.canList">canList</a></li><li data-type='method'><a href="module-server_api_locations.html#.canRetrieve">canRetrieve</a></li><li data-type='method'><a href="module-server_api_locations.html#.canUpdate">canUpdate</a></li><li data-type='method'><a href="module-server_api_locations.html#.create">create</a></li><li data-type='method'><a href="module-server_api_locations.html#.destroy">destroy</a></li><li data-type='method'><a href="module-server_api_locations.html#.fetchLocation">fetchLocation</a></li><li data-type='method'><a href="module-server_api_locations.html#.list">list</a></li><li data-type='method'><a href="module-server_api_locations.html#.parse">parse</a></li><li data-type='method'><a href="module-server_api_locations.html#.retrieve">retrieve</a></li><li data-type='method'><a href="module-server_api_locations.html#.serialize">serialize</a></li><li data-type='method'><a href="module-server_api_locations.html#.update">update</a></li><li data-type='method'><a href="module-server_api_locations.html#~validateListRequest">validateListRequest</a></li><li data-type='method'><a href="module-server_api_locations.html#~validateLocation">validateLocation</a></li></ul></li><li><a href="module-server_api_users.html">server/api/users</a><ul class='methods'><li data-type='method'><a href="module-server_api_users.html#.canRetrieve">canRetrieve</a></li><li data-type='method'><a href="module-server_api_users.html#.fetchMe">fetchMe</a></li><li data-type='method'><a href="module-server_api_users.html#.fetchUser">fetchUser</a></li><li data-type='method'><a href="module-server_api_users.html#.retrieve">retrieve</a></li><li data-type='method'><a href="module-server_api_users.html#.serialize">serialize</a></li></ul></li><li><a href="module-server_api_utils_api.html">server/api/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_api.html#.fetcher">fetcher</a></li><li data-type='method'><a href="module-server_api_utils_api.html#.route">route</a></li><li data-type='method'><a href="module-server_api_utils_api.html#.transactionalRoute">transactionalRoute</a></li></ul></li><li><a href="module-server_api_utils_auth.html">server/api/utils/auth</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_auth.html#~authenticatedResourceLoader">authenticatedResourceLoader</a></li><li data-type='method'><a href="module-server_api_utils_auth.html#~authenticationErrorHandler">authenticationErrorHandler</a></li><li data-type='method'><a href="module-server_api_utils_auth.html#~authorizationErrorHandler">authorizationErrorHandler</a></li></ul></li><li><a href="module-server_api_utils_errors.html">server/api/utils/errors</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_errors.html#.forbidden">forbidden</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.invalidAuthorization">invalidAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.malformedAuthorization">malformedAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.missingAuthorization">missingAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.notFound">notFound</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.recordNotFound">recordNotFound</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.unauthorized">unauthorized</a></li></ul></li><li><a href="module-server_api_utils_filters.html">server/api/utils/filters</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_filters.html#.bbox">bbox</a></li></ul></li><li><a href="module-server_api_utils_policy.html">server/api/utils/policy</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_policy.html#.hasRole">hasRole</a></li><li data-type='method'><a href="module-server_api_utils_policy.html#.sameRecord">sameRecord</a></li></ul></li><li><a href="module-server_api_utils_validation.html">server/api/utils/validation</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_validation.html#.validateRequestBody">validateRequestBody</a></li><li data-type='method'><a href="module-server_api_utils_validation.html#.validateValue">validateValue</a></li></ul></li><li><a href="module-server_api_validators_generic.html">server/api/validators/generic</a><ul class='methods'><li data-type='method'><a href="module-server_api_validators_generic.html#.equals">equals</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.isSetAndNotNull">isSetAndNotNull</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.properties">properties</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.query">query</a></li></ul></li><li><a href="module-server_api_validators_geojson.html">server/api/validators/geojson</a><ul class='methods'><li data-type='method'><a href="module-server_api_validators_geojson.html#.bboxString">bboxString</a></li><li data-type='method'><a href="module-server_api_validators_geojson.html#.point">point</a></li></ul></li><li><a href="module-server_spec_fixtures_geojson.html">server/spec/fixtures/geojson</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_geojson.html#.coordinates">coordinates</a></li><li data-type='method'><a href="module-server_spec_fixtures_geojson.html#.point">point</a></li></ul></li><li><a href="module-server_spec_fixtures_location.html">server/spec/fixtures/location</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_location.html#.location">location</a></li><li data-type='method'><a href="module-server_spec_fixtures_location.html#.name">name</a></li><li data-type='method'><a href="module-server_spec_fixtures_location.html#.shortName">shortName</a></li></ul></li><li><a href="module-server_spec_fixtures_user.html">server/spec/fixtures/user</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_user.html#.admin">admin</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.email">email</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.password">password</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.user">user</a></li></ul></li><li><a href="module-server_spec_utils.html">server/spec/utils</a><ul class='methods'><li data-type='method'><a href="module-server_spec_utils.html#.expectDeleted">expectDeleted</a></li><li data-type='method'><a href="module-server_spec_utils.html#.expectErrors">expectErrors</a></li><li data-type='method'><a href="module-server_spec_utils.html#.expectUnchanged">expectUnchanged</a></li></ul></li><li><a href="module-server_utils_express.html">server/utils/express</a><ul class='methods'><li data-type='method'><a href="module-server_utils_express.html#.ensureRequest">ensureRequest</a></li><li data-type='method'><a href="module-server_utils_express.html#.logger">logger</a></li></ul></li><li><a href="module-server_utils_jwt.html">server/utils/jwt</a><ul class='methods'><li data-type='method'><a href="module-server_utils_jwt.html#.generateToken">generateToken</a></li></ul></li><li><a href="module-server_utils_knex.html">server/utils/knex</a><ul class='methods'><li data-type='method'><a href="module-server_utils_knex.html#.logger">logger</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.logMigration">logMigration</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/api/locations/locations.api.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Locations management API.
 *
 * @module server/api/locations
 */
const serialize = require('express-serializer');

const Location = require('../../models/location');
const { fetcher, route } = require('../utils/api');
const { bbox: filterByBbox } = require('../utils/filters');
const { validateRequestBody, validateValue } = require('../utils/validation');
const { point: validateGeoJsonPoint } = require('../validators/geojson');
const policy = require('./locations.policy');

// API resource name (used in some API errors)
exports.resourceName = 'location';

/**
 * Creates a new location.
 *
 * @function
 */
exports.create = route(async (req, res) => {

  await validateLocation(req);

  const location = policy.parse(req.body);
  await location.save();

  res.status(201).send(await serialize(req, location, policy));
});

/**
 * Lists locations ordered by name.
 *
 * @function
 */
exports.list = route(async (req, res) => {

  await validateListRequest(req);

  let query = new Location();

  if (req.query.bbox) {
    query = filterByBbox(query, req.query.bbox);
  }

  const locations = await query.orderBy('name').orderBy('created_at').fetchAll();

  res.send(await serialize(req, locations.models, policy));
});

/**
 * Retrieves a single location.
 *
 * @function
 */
exports.retrieve = route(async (req, res) => {
  res.send(await serialize(req, req.location, policy));
});

/**
 * Updates a location.
 *
 * @function
 */
exports.update = route(async (req, res) => {

  await validateLocation(req, true);

  const location = req.location;
  policy.parse(req.body, location);

  if (location.hasChanged()) {
    await location.save();
  }

  res.send(await serialize(req, location, policy));
});

/**
 * Deletes a location.
 *
 * @function
 */
exports.destroy = route(async (req, res) => {
  await req.location.destroy();
  res.sendStatus(204);
});

/**
 * Middleware that fetches the location identified by the ID in the URL.
 *
 * @function
 */
exports.fetchLocation = fetcher({
  model: Location,
  resourceName: exports.resourceName,
  coerce: id => id.toLowerCase(),
  validate: 'uuid'
});

/**
 * Validates the query parameters of a request to list locations.
 *
 * @param {Request} req - An Express request object.
 * @returns {Promise&lt;ValidationErrorBundle>} - A promise that will be resolved if the request is valid, or rejected with a bundle of errors if it is invalid.
 */
function validateListRequest(req) {
  return validateValue(req, 422, function() {
    return this.parallel(
      this.validate(
        this.query('bbox'),
        this.while(this.isSet()),
        this.notBlank(),
        this.bboxString()
      )
    );
  });
}

/**
 * Validates the location in the request body.
 *
 * @param {Request} req - An Express request object.
 * @param {boolean} [patchMode=false] - If true, only properties that are set will be validated (i.e. a partial update with a PATCH request).
 * @returns {Promise&lt;ValidationErrorBundle>} - A promise that will be resolved if the location is valid, or rejected with a bundle of errors if it is invalid.
 */
function validateLocation(req, patchMode = false) {
  return validateRequestBody(req, function() {
    return this.parallel(
      this.validate(
        this.json('/name'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('string'),
        this.notBlank(),
        this.string(1, 150)
      ),
      this.validate(
        this.json('/shortName'),
        this.while(this.isSetAndNotNull()),
        this.type('string'),
        this.notBlank(),
        this.string(1, 30)
      ),
      this.validate(
        this.json('/description'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('string'),
        this.notBlank(),
        this.string(1, 2000)
      ),
      this.validate(
        this.json('/phone'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('string'),
        this.notBlank(),
        this.string(1, 20)
      ),
      this.validate(
        this.json('/photoUrl'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('string'),
        this.notBlank(),
        this.string(1, 500)
      ),
      this.validate(
        this.json('/siteUrl'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('string'),
        this.notBlank(),
        this.string(1, 500)
      ),
      this.validate(
        this.json('/geometry'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.geoJsonPoint()
      ),
      this.validate(
        this.json('/properties'),
        this.while(this.isSet()),
        this.type('object')
      ),
      this.validate(
        this.json('/address'),
        this.if(patchMode, this.while(this.isSet())),
        this.required(),
        this.type('object'),
        this.parallel(
          this.validate(
            this.json('/street'),
            this.if(patchMode, this.while(this.isSet())),
            this.required(),
            this.type('string'),
            this.notBlank(),
            this.string(1, 150),
            this.notBlank()
          ),
          this.validate(
            this.json('/number'),
            this.while(this.isSetAndNotNull()),
            this.type('string'),
            this.string(1, 10),
            this.notBlank()
          ),
          this.validate(
            this.json('/zipCode'),
            this.if(patchMode, this.while(this.isSet())),
            this.required(),
            this.type('string'),
            this.notBlank(),
            this.string(1, 15),
            this.notBlank()
          ),
          this.validate(
            this.json('/city'),
            this.if(patchMode, this.while(this.isSet())),
            this.required(),
            this.type('string'),
            this.notBlank(),
            this.string(1, 100),
            this.notBlank()
          ),
          this.validate(
            this.json('/state'),
            this.if(patchMode, this.while(this.isSet())),
            this.required(),
            this.type('string'),
            this.notBlank(),
            this.string(1, 30),
            this.notBlank()
          )
        )
      )
    );
  });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Dec 19 2017 10:25:00 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
