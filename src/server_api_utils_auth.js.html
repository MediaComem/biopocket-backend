<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/api/utils/auth.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Abstract.html">Abstract</a><ul class='methods'><li data-type='method'><a href="Abstract.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="Abstract.html#serializeTo">serializeTo</a></li></ul></li><li><a href="Database.html">Database</a><ul class='methods'><li data-type='method'><a href="Database.html#close">close</a></li><li data-type='method'><a href="Database.html#open">open</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="Location.html#serializeTo">serializeTo</a></li></ul></li><li><a href="module-scripts.AnonymizeScript.html">AnonymizeScript</a></li><li><a href="module-scripts.CreateAdminScript.html">CreateAdminScript</a></li><li><a href="module-scripts.SampleDataScript.html">SampleDataScript</a></li><li><a href="module-scripts-Script.html">Script</a><ul class='methods'><li data-type='method'><a href="module-scripts-Script.html#autoRun">autoRun</a></li><li data-type='method'><a href="module-scripts-Script.html#exit">exit</a></li><li data-type='method'><a href="module-scripts-Script.html#onFailure">onFailure</a></li><li data-type='method'><a href="module-scripts-Script.html#onSuccess">onSuccess</a></li><li data-type='method'><a href="module-scripts-Script.html#run">run</a></li></ul></li><li><a href="module-server_api_utils_errors-ApiError.html">ApiError</a></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#generateJwt">generateJwt</a></li><li data-type='method'><a href="User.html#hasPassword">hasPassword</a></li><li data-type='method'><a href="User.html#hasRole">hasRole</a></li><li data-type='method'><a href="User.html#isActive">isActive</a></li><li data-type='method'><a href="User.html#parseFrom">parseFrom</a></li><li data-type='method'><a href="User.html#serializeTo">serializeTo</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-scripts.html">scripts</a></li><li><a href="module-server_api_auth.html">server/api/auth</a><ul class='methods'><li data-type='method'><a href="module-server_api_auth.html#.authenticate">authenticate</a></li><li data-type='method'><a href="module-server_api_auth.html#.canAuthenticate">canAuthenticate</a></li></ul></li><li><a href="module-server_api_locations.html">server/api/locations</a><ul class='methods'><li data-type='method'><a href="module-server_api_locations.html#.canCreate">canCreate</a></li><li data-type='method'><a href="module-server_api_locations.html#.canDestroy">canDestroy</a></li><li data-type='method'><a href="module-server_api_locations.html#.canList">canList</a></li><li data-type='method'><a href="module-server_api_locations.html#.canRetrieve">canRetrieve</a></li><li data-type='method'><a href="module-server_api_locations.html#.canUpdate">canUpdate</a></li><li data-type='method'><a href="module-server_api_locations.html#.create">create</a></li><li data-type='method'><a href="module-server_api_locations.html#.destroy">destroy</a></li><li data-type='method'><a href="module-server_api_locations.html#.fetchLocation">fetchLocation</a></li><li data-type='method'><a href="module-server_api_locations.html#.list">list</a></li><li data-type='method'><a href="module-server_api_locations.html#.parse">parse</a></li><li data-type='method'><a href="module-server_api_locations.html#.retrieve">retrieve</a></li><li data-type='method'><a href="module-server_api_locations.html#.serialize">serialize</a></li><li data-type='method'><a href="module-server_api_locations.html#.update">update</a></li><li data-type='method'><a href="module-server_api_locations.html#~validateListRequest">validateListRequest</a></li><li data-type='method'><a href="module-server_api_locations.html#~validateLocation">validateLocation</a></li></ul></li><li><a href="module-server_api_users.html">server/api/users</a><ul class='methods'><li data-type='method'><a href="module-server_api_users.html#.canRetrieve">canRetrieve</a></li><li data-type='method'><a href="module-server_api_users.html#.fetchMe">fetchMe</a></li><li data-type='method'><a href="module-server_api_users.html#.fetchUser">fetchUser</a></li><li data-type='method'><a href="module-server_api_users.html#.retrieve">retrieve</a></li><li data-type='method'><a href="module-server_api_users.html#.serialize">serialize</a></li></ul></li><li><a href="module-server_api_utils_api.html">server/api/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_api.html#.fetcher">fetcher</a></li><li data-type='method'><a href="module-server_api_utils_api.html#.route">route</a></li><li data-type='method'><a href="module-server_api_utils_api.html#.transactionalRoute">transactionalRoute</a></li></ul></li><li><a href="module-server_api_utils_auth.html">server/api/utils/auth</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_auth.html#~authenticatedResourceLoader">authenticatedResourceLoader</a></li><li data-type='method'><a href="module-server_api_utils_auth.html#~authenticationErrorHandler">authenticationErrorHandler</a></li><li data-type='method'><a href="module-server_api_utils_auth.html#~authorizationErrorHandler">authorizationErrorHandler</a></li></ul></li><li><a href="module-server_api_utils_errors.html">server/api/utils/errors</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_errors.html#.forbidden">forbidden</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.invalidAuthorization">invalidAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.malformedAuthorization">malformedAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.missingAuthorization">missingAuthorization</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.notFound">notFound</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.recordNotFound">recordNotFound</a></li><li data-type='method'><a href="module-server_api_utils_errors.html#.unauthorized">unauthorized</a></li></ul></li><li><a href="module-server_api_utils_filters.html">server/api/utils/filters</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_filters.html#.bbox">bbox</a></li></ul></li><li><a href="module-server_api_utils_policy.html">server/api/utils/policy</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_policy.html#.hasRole">hasRole</a></li><li data-type='method'><a href="module-server_api_utils_policy.html#.sameRecord">sameRecord</a></li></ul></li><li><a href="module-server_api_utils_validation.html">server/api/utils/validation</a><ul class='methods'><li data-type='method'><a href="module-server_api_utils_validation.html#.validateRequestBody">validateRequestBody</a></li><li data-type='method'><a href="module-server_api_utils_validation.html#.validateValue">validateValue</a></li></ul></li><li><a href="module-server_api_validators_generic.html">server/api/validators/generic</a><ul class='methods'><li data-type='method'><a href="module-server_api_validators_generic.html#.equals">equals</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.isSetAndNotNull">isSetAndNotNull</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.properties">properties</a></li><li data-type='method'><a href="module-server_api_validators_generic.html#.query">query</a></li></ul></li><li><a href="module-server_api_validators_geojson.html">server/api/validators/geojson</a><ul class='methods'><li data-type='method'><a href="module-server_api_validators_geojson.html#.bboxString">bboxString</a></li><li data-type='method'><a href="module-server_api_validators_geojson.html#.point">point</a></li></ul></li><li><a href="module-server_spec_fixtures_geojson.html">server/spec/fixtures/geojson</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_geojson.html#.coordinates">coordinates</a></li><li data-type='method'><a href="module-server_spec_fixtures_geojson.html#.point">point</a></li></ul></li><li><a href="module-server_spec_fixtures_location.html">server/spec/fixtures/location</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_location.html#.location">location</a></li><li data-type='method'><a href="module-server_spec_fixtures_location.html#.name">name</a></li><li data-type='method'><a href="module-server_spec_fixtures_location.html#.shortName">shortName</a></li></ul></li><li><a href="module-server_spec_fixtures_user.html">server/spec/fixtures/user</a><ul class='methods'><li data-type='method'><a href="module-server_spec_fixtures_user.html#.admin">admin</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.email">email</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.password">password</a></li><li data-type='method'><a href="module-server_spec_fixtures_user.html#.user">user</a></li></ul></li><li><a href="module-server_spec_utils.html">server/spec/utils</a><ul class='methods'><li data-type='method'><a href="module-server_spec_utils.html#.expectDeleted">expectDeleted</a></li><li data-type='method'><a href="module-server_spec_utils.html#.expectErrors">expectErrors</a></li><li data-type='method'><a href="module-server_spec_utils.html#.expectUnchanged">expectUnchanged</a></li></ul></li><li><a href="module-server_utils_express.html">server/utils/express</a><ul class='methods'><li data-type='method'><a href="module-server_utils_express.html#.ensureRequest">ensureRequest</a></li><li data-type='method'><a href="module-server_utils_express.html#.logger">logger</a></li></ul></li><li><a href="module-server_utils_jwt.html">server/utils/jwt</a><ul class='methods'><li data-type='method'><a href="module-server_utils_jwt.html#.generateToken">generateToken</a></li></ul></li><li><a href="module-server_utils_knex.html">server/utils/knex</a><ul class='methods'><li data-type='method'><a href="module-server_utils_knex.html#.logger">logger</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.logMigration">logMigration</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/api/utils/auth.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Configuration of the [express-jwt-policies](https://www.npmjs.com/package/express-jwt-policies) library.
 *
 * The settings in this file influence the behavior of the `auth.authenticate`
 * and `auth.authorize` functions used throughout `*.routes.js` files (in
 * `server/api/{subject}` directories) for authentication and/or authorization.
 *
 * @module server/api/utils/auth
 */
const expressJwtPolicies = require('express-jwt-policies');

const config = require('../../../config');
const User = require('../../models/user');
const errors = require('./errors');

const logger = config.logger('auth');

module.exports = expressJwtPolicies({

  /**
   * This middleware function is called by **express-jwt-policies** after
   * successful validation of a JWT token.
   *
   * It loads the user account corresponding to the "sub" claim of the token,
   * and attaches it to `req.currentUser` for later use by other middleware
   * functions.
   *
   * If no matching user is found or the user is inactive, a standard
   * unauthorized error (see {@link module:server/api/utils/errors}) is
   * forwarded to the next error middleware.  If another unexpected error
   * occurs, it is also forwarded to the next error-handling middleware.
   *
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authenticatedResourceLoader: function(req, res, next) {
    return User.where({
      api_id: req.jwtToken.sub || ''
    }).fetch().then(user => {
      if (!user || !user.isActive()) {
        throw errors.invalidAuthorization();
      }

      req.currentUser = user;
      logger.debug(`Authenticated as user ${user.get('api_id')}`);
    }).then(next).catch(next);
  },

  /**
   * This error-handling middleware function is called by
   * **express-jwt-policies** if an authentication error occurs (i.e. a problem
   * with the JWT token or the authenticated resource loader above).
   *
   * If the error is a known error such as a missing or malformed JWT token, it
   * is replaced by a standard unauthorized error (see {@link
   * module:server/api/utils/errors}) and forwarded to the next error-handling
   * middleware. Unexpected errors are forwarded without change.
   *
   * @param {Error} err - The error that occurred.
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authenticationErrorHandler: function(err, req, res, next) {
    if (err.code == 'credentials_required') {
      logger.debug(`JWT authentication missing error: ${err.message}`);
      next(errors.missingAuthorization());
    } else if (err.code == 'credentials_bad_format' || err.code == 'credentials_bad_scheme') {
      logger.debug(`JWT authentication credentials error: ${err.message}`);
      next(errors.malformedAuthorization());
    } else if (err.status == 401) {
      logger.debug(`JWT authentication invalid error: ${err.message}`);
      next(errors.invalidAuthorization());
    } else {
      next(err);
    }
  },

  /**
   * This error-handling middleware function is called by
   * **express-jwt-policies** if an authorization error occurs (i.e. a custom
   * policy function determined that a user does not have access to a specific
   * resource).
   *
   * Such an error is usually replaced by a standard forbidden error (see {@link
   * module:server/api/utils/errors}) and forwarded to the next error-handling
   * middleware.
   *
   * However, if the authorization options passed to `auth.authorize` include a
   * `resourceName` property and a resource ID is found in `req.params.id`, then
   * the error will instead be replaced by a standard record not found (404)
   * error.
   *
   * This is meant to prevent unauthorized user from being able to tell the
   * difference between a resource that does not exist and a resource which they
   * are not authorized to access. If the former produced a 404 Not Found
   * response and the latter a 403 Forbidden response, it would be a dead
   * giveaway that the latter resource exists while the former does not.
   * Responding with 404 Not Found in both cases conceals that information.
   *
   * If the resource has an identifier which is not `req.params.id`, a custom
   * `resourceId` function can be passed to `auth.authorize` to retrieve the
   * correct ID from the request:
   *
   *     auth.authorize(policyFunc, {
   *       resourceName: 'user',
   *       resourceId: (req) => req.params.customId
   *     });
   *
   * @param {Error} err - The error that occurred.
   * @param {Request} req - Express request object.
   * @param {Response} res - Express response object.
   * @param {function} next - Function that calls the next middleware in the stack.
   * @see https://www.npmjs.com/package/express-jwt-policies
   */
  authorizationErrorHandler: function(err, req, res, next) {
    if (err.status != 403) {
      return next(err);
    }

    const resourceName = req.authOptions.resourceName;
    const resourceId = req.authOptions.resourceId ? req.authOptions.resourceId(req) : req.params.id;
    if (resourceName &amp;&amp; resourceId) {
      next(errors.recordNotFound(resourceName, resourceId));
      logger.debug(`Not authorized to access resource ${req.path} (${resourceName}/${resourceId})`);
    } else {
      next(errors.forbidden());
      logger.debug(`Not authorized to access resource ${req.path}`);
    }
  },

  // JWT secret used by the **express-jwt-policies** library to verify token
  // signatures, taken from the server's configuration.
  jwtSecret: config.sessionSecret
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Dec 19 2017 10:25:00 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
